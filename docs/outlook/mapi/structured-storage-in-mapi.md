---
title: Structure Stockage mapi
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: Dernière modification le 9 mars 2015
ms.openlocfilehash: f58fa70e98841db5507323a63737f1df6c1b7a6d
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/28/2019
ms.locfileid: "33411749"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="9b59b-103">Structure Stockage mapi</span><span class="sxs-lookup"><span data-stu-id="9b59b-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="9b59b-104">**S’applique à** : Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="9b59b-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="9b59b-105">Le stockage structuré fait référence à l’organisation hiérarchique de stockage introduite avec COM.</span><span class="sxs-lookup"><span data-stu-id="9b59b-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="9b59b-106">Dans un environnement de stockage structuré, le stockage est organisé en deux ou trois types d’objets :</span><span class="sxs-lookup"><span data-stu-id="9b59b-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="9b59b-107">Objets Stream</span><span class="sxs-lookup"><span data-stu-id="9b59b-107">Stream objects</span></span>
    
- <span data-ttu-id="9b59b-108">Verrouiller les objets d’octets</span><span class="sxs-lookup"><span data-stu-id="9b59b-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="9b59b-109">Stockage objets</span><span class="sxs-lookup"><span data-stu-id="9b59b-109">Storage objects</span></span>
    
<span data-ttu-id="9b59b-110">Les octets de flux et de verrouillage sont des objets de niveau inférieur qui accèdent directement aux données.</span><span class="sxs-lookup"><span data-stu-id="9b59b-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="9b59b-111">Les objets Stream implémentent l’interface **IStream** qui définit des méthodes de lecture, d’écriture, de positionnement et de copie d’octets de données.</span><span class="sxs-lookup"><span data-stu-id="9b59b-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="9b59b-112">Les objets d’octets de verrouillage implémentent une autre interface COM, **ILockBytes,** pour accéder aux données avec un tableau d’octets.</span><span class="sxs-lookup"><span data-stu-id="9b59b-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="9b59b-113">Les tableaux d’byte sont généralement utilisés pour fournir un accès personnalisé au stockage sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="9b59b-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="9b59b-114">Stockage objets sont superposés au-dessus du flux ou verrouillent des objets d’octets ; Ils peuvent contenir un ou plusieurs de ces objets, ainsi que d’autres objets de stockage.</span><span class="sxs-lookup"><span data-stu-id="9b59b-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="9b59b-115">Stockage implémentent l’interface **IStorage** qui définit les méthodes de création, d’accès et de maintenance des objets imbrmbrés.</span><span class="sxs-lookup"><span data-stu-id="9b59b-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="9b59b-116">Étant **donné que IStream,** **ILockBytes** et **IStorage** sont des interfaces COM plutôt que des interfaces MAPI, leurs méthodes retournent des valeurs d’erreur COM plutôt que des valeurs MAPI.</span><span class="sxs-lookup"><span data-stu-id="9b59b-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="9b59b-117">Les clients et fournisseurs de services appelant des méthodes dans ces interfaces doivent utiliser la fonction API **MapStorageSCode** pour traduire ces valeurs en valeurs d’erreur MAPI.</span><span class="sxs-lookup"><span data-stu-id="9b59b-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="9b59b-118">Pour plus d’informations, [voir MapStorageSCode.](mapstoragescode.md)</span><span class="sxs-lookup"><span data-stu-id="9b59b-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="9b59b-119">Les clients et les fournisseurs de services utilisent un stockage structuré pour utiliser des propriétés trop grandes pour être utilisées avec les méthodes **IMAPIProp,** généralement des propriétés binaires et de chaîne de grande taille.</span><span class="sxs-lookup"><span data-stu-id="9b59b-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="9b59b-120">L’une des méthodes courantes d’accès des clients ou des fournisseurs de services consiste à spécifier **IStream** ou **IStorage** comme identificateur d’interface dans un appel à la méthode [IMAPIProp::OpenProperty.](imapiprop-openproperty.md)</span><span class="sxs-lookup"><span data-stu-id="9b59b-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="9b59b-121">Par exemple, les clients appellent **OpenProperty** avec **PR_ATTACH_DATA_BIN** comme balise de propriété et IID_IStream comme identificateur d’interface pour accéder à une pièce jointe binaire dans un message.</span><span class="sxs-lookup"><span data-stu-id="9b59b-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="9b59b-122">Les clients et les fournisseurs de services peuvent implémenter leurs propres objets de flux et de stockage, ou appeler des fonctions d’API pour accéder aux implémentations fournies par MAPI ou COM.</span><span class="sxs-lookup"><span data-stu-id="9b59b-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="9b59b-123">Étant donné que les implémentations fournies servent la plupart des objectifs, les clients et les fournisseurs de services ont rarement besoin de créer leurs propres implémentations.</span><span class="sxs-lookup"><span data-stu-id="9b59b-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="9b59b-124">Lorsqu’un client appelle **OpenProperty** sur un objet MAPI pour accéder à l’une de ses propriétés via un objet de stockage, le fournisseur de services ouvre généralement l’objet de stockage en mode direct.</span><span class="sxs-lookup"><span data-stu-id="9b59b-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="9b59b-125">Toutefois, il s’agit d’un comportement classique plutôt que obligatoire.</span><span class="sxs-lookup"><span data-stu-id="9b59b-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="9b59b-126">Les clients doivent supposer que tous les objets de stockage ouverts ou créés par des fournisseurs de services sont transposés et nécessitent un appel à **IStorage::Commit**.</span><span class="sxs-lookup"><span data-stu-id="9b59b-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="9b59b-127">Ils doivent également se souvenir que les modifications apportées aux objets de stockage ne seront  pas définitives tant qu’ils n’appelleront **pas IMAPIProp::SaveChanges** après la validation finale pour enregistrer l’objet MAPI.</span><span class="sxs-lookup"><span data-stu-id="9b59b-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="9b59b-128">Pour plus d’informations, [voir IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="9b59b-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="9b59b-129">MAPI et COM fournissent plusieurs fonctions API pour définir ou accéder aux objets de stockage et de flux.</span><span class="sxs-lookup"><span data-stu-id="9b59b-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="9b59b-130">Les fonctions couramment utilisées sont décrites dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="9b59b-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="9b59b-131">**Fonctions pour accéder aux objets Stockage et Stream**</span><span class="sxs-lookup"><span data-stu-id="9b59b-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="9b59b-132">**Fonction**</span><span class="sxs-lookup"><span data-stu-id="9b59b-132">**Function**</span></span>|<span data-ttu-id="9b59b-133">**Description**</span><span class="sxs-lookup"><span data-stu-id="9b59b-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="9b59b-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="9b59b-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="9b59b-135">Crée un objet de stockage pour accéder à un flux ou verrouiller un objet octets.</span><span class="sxs-lookup"><span data-stu-id="9b59b-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="9b59b-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="9b59b-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="9b59b-137">Crée un objet message pour accéder à un objet de stockage.</span><span class="sxs-lookup"><span data-stu-id="9b59b-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="9b59b-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="9b59b-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="9b59b-139">Crée un objet de flux pour accéder à un fichier.</span><span class="sxs-lookup"><span data-stu-id="9b59b-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="9b59b-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="9b59b-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="9b59b-141">Crée un objet stream qui contient la version compressée ou non compressée d’un flux contenant le texte enrichi d’un message.</span><span class="sxs-lookup"><span data-stu-id="9b59b-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="9b59b-142">**Pour récupérer les noms des flux dans un sous-torage donné**</span><span class="sxs-lookup"><span data-stu-id="9b59b-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="9b59b-143">Appelez la méthode **IStorage::EnumElements** du sous-torage pour obtenir une interface **IEnumSTATSTG.**</span><span class="sxs-lookup"><span data-stu-id="9b59b-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="9b59b-144">Appelez **IEnumSTATSTG::Next** avec autant de structures **STATSTG** à la fois que possible.</span><span class="sxs-lookup"><span data-stu-id="9b59b-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="9b59b-145">Si vous demandez 100 à la fois, **Next** retourne généralement S_FALSE avec le contenu  _de pceltFetched_ définie sur le nombre réellement récupéré.</span><span class="sxs-lookup"><span data-stu-id="9b59b-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="9b59b-146">Recherchez les structures **STATSTG** marquées avec des STGTY_STREAM.</span><span class="sxs-lookup"><span data-stu-id="9b59b-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="9b59b-147">Relâchez _le paramètre pwcsName._</span><span class="sxs-lookup"><span data-stu-id="9b59b-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="9b59b-148">**Pour créer un objet de stockage pour accéder à un flux existant ou verrouiller un objet octets**</span><span class="sxs-lookup"><span data-stu-id="9b59b-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="9b59b-149">Les clients [appellent HrIStorageFromStream](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="9b59b-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="9b59b-150">**Pour créer un objet message pour accéder à un objet de stockage existant**</span><span class="sxs-lookup"><span data-stu-id="9b59b-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="9b59b-151">Les fournisseurs de services et les clients [appellent OpenIMsgOnIStg](openimsgonistg.md).</span><span class="sxs-lookup"><span data-stu-id="9b59b-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="9b59b-152">L’objet de message créé diffère des objets de message généralement créés par les fournisseurs de magasins de messages dans la mesure où il ne prend pas en charge toutes les méthodes d’interface [IMessage : IMAPIProp,](imessageimapiprop.md) telles que **IMessage::SubmitMessage**.</span><span class="sxs-lookup"><span data-stu-id="9b59b-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="9b59b-153">Un paramètre d’entrée facultatif pour **OpenIMsgOnIStg** est une fonction de rappel conforme au prototype [MSGCALLRELEASE.](msgcallrelease.md)</span><span class="sxs-lookup"><span data-stu-id="9b59b-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="9b59b-154">Cette fonction est appelée par le nouvel objet message lorsque le nombre de références du message atteint zéro.</span><span class="sxs-lookup"><span data-stu-id="9b59b-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="9b59b-155">**L’implémentation d’une fonction MSGCALLRELEASE** peut être utile pour effectuer un traitement final avant la suppression complète du nouveau message.</span><span class="sxs-lookup"><span data-stu-id="9b59b-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="9b59b-156">[OpenStreamOnFile est](openstreamonfile.md) couramment utilisé pour le stockage des pièces jointes, car il crée un flux qui lit et écrit dans un fichier.</span><span class="sxs-lookup"><span data-stu-id="9b59b-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="9b59b-157">**OpenProperty** avec **PR_ATTACH_DATA_BIN** la balise de propriété crée un flux pour le stockage des données de pièces jointes binaires.</span><span class="sxs-lookup"><span data-stu-id="9b59b-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="9b59b-158">**Pour compresser ou décompresser un flux contenant du texte de message au format Texte enrichi**</span><span class="sxs-lookup"><span data-stu-id="9b59b-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="9b59b-159">Les clients [appellent WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="9b59b-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="9b59b-160">**WrapCompressedRTFStream** crée un flux qui encapsule le flux RTF.</span><span class="sxs-lookup"><span data-stu-id="9b59b-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="9b59b-161">Le flux wrapper n’implémente pas toutes les **méthodes IStream** ; les méthodes suivantes sont exclues : **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat** et **Clone**.</span><span class="sxs-lookup"><span data-stu-id="9b59b-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="9b59b-162">Cela est dû au fait que les objets de flux créés par **WrapCompressedRTFStream** ne prendre en charge **ni SetSize** ni **Stat**, il n’existe pas de moyen simple d’étendre ou de récupérer leur taille.</span><span class="sxs-lookup"><span data-stu-id="9b59b-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="9b59b-163">La meilleure stratégie consiste à sélectionner une taille de mémoire tampon raisonnable et à lire ou écrire dans une boucle.</span><span class="sxs-lookup"><span data-stu-id="9b59b-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="9b59b-164">COM a une implémentation d’objet de stockage basée sur un tableau d’byte qui renvoie un objet **IEnumSTATSTG** à partir de la méthode **EnumElements** qui pose problème.</span><span class="sxs-lookup"><span data-stu-id="9b59b-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="9b59b-165">En particulier, la **méthode QueryInterface** ne fonctionne pas correctement.</span><span class="sxs-lookup"><span data-stu-id="9b59b-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="9b59b-166">Les fournisseurs de services qui implémentent leurs propres objets de stockage à l’aide de l’implémentation COM doivent créer un wrapper fin pour l’objet **IEnumSTATSTG** qui forwarde les appels aux méthodes **IEnumSTATSTG** sous-jacentes, mais implémente ses propres méthodes **AddRef,** **Release,** **QueryInterface** et **Clone.**</span><span class="sxs-lookup"><span data-stu-id="9b59b-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

