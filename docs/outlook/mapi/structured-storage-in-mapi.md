---
title: Stockage structuré dans MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: Dernière modification le 09 mars 2015
ms.openlocfilehash: 937643d90534f73477b90fd7ce883615a7e296f2
ms.sourcegitcommit: 0cf39e5382b8c6f236c8a63c6036849ed3527ded
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/23/2018
ms.locfileid: "22569714"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="dde94-103">Stockage structuré dans MAPI</span><span class="sxs-lookup"><span data-stu-id="dde94-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="dde94-104">**S’applique à**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="dde94-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="dde94-105">Stockage structuré fait référence à l’organisation hiérarchique de stockage introduit avec COM.</span><span class="sxs-lookup"><span data-stu-id="dde94-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="dde94-106">Dans un environnement de stockage structuré, le stockage est divisé en deux ou trois types d’objets :</span><span class="sxs-lookup"><span data-stu-id="dde94-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="dde94-107">Objets Stream</span><span class="sxs-lookup"><span data-stu-id="dde94-107">Stream objects</span></span>
    
- <span data-ttu-id="dde94-108">Verrouiller les objets octets</span><span class="sxs-lookup"><span data-stu-id="dde94-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="dde94-109">Objets de stockage</span><span class="sxs-lookup"><span data-stu-id="dde94-109">Storage objects</span></span>
    
<span data-ttu-id="dde94-110">Flux et verrouiller octets sont des objets de niveau inférieur qui accéder directement aux données.</span><span class="sxs-lookup"><span data-stu-id="dde94-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="dde94-111">Objets Stream implémentent l’interface **IStream** qui définit des méthodes pour la lecture, écriture, de positionnement et la copie des octets de données.</span><span class="sxs-lookup"><span data-stu-id="dde94-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="dde94-112">Verrouiller les objets octets implémentent une autre interface COM, **ILockBytes**, pour accéder aux données avec un tableau d’octets.</span><span class="sxs-lookup"><span data-stu-id="dde94-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="dde94-113">Les tableaux d’octets sont généralement utilisés pour fournir un accès personnalisé vers un stockage sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="dde94-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="dde94-114">Objets de stockage sont basés sur les objets octets flux ou de verrou ; ils peuvent contenir une ou plusieurs de ces objets ainsi que d’autres objets de stockage.</span><span class="sxs-lookup"><span data-stu-id="dde94-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="dde94-115">Objets de stockage implémentent l’interface **IStorage** qui définit des méthodes pour la création, d’accès et de gestion des objets imbriqués.</span><span class="sxs-lookup"><span data-stu-id="dde94-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="dde94-116">Étant **IStream**, **ILockBytes**et **IStorage** interfaces COM plutôt que des interfaces MAPI, leurs méthodes renvoient des valeurs d’erreur COM plutôt que des valeurs MAPI.</span><span class="sxs-lookup"><span data-stu-id="dde94-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="dde94-117">Clients et fournisseurs de services de l’appel de méthodes dans ces interfaces doivent utiliser la fonction API **MapStorageSCode** pour convertir ces valeurs en valeurs d’erreur MAPI.</span><span class="sxs-lookup"><span data-stu-id="dde94-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="dde94-118">Pour plus d’informations, voir [MapStorageSCode](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="dde94-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="dde94-119">Clients et fournisseurs de services d’utilisent le stockage structuré pour travailler avec les propriétés qui sont trop volumineux pour tenir à jour les méthodes **IMAPIProp** , chaîne généralement volumineux et propriétés binaires.</span><span class="sxs-lookup"><span data-stu-id="dde94-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="dde94-120">Une des méthodes courantes que les clients ou fournisseurs de services y accéder est en spécifiant l’identificateur d’interface dans un appel à la méthode [IMAPIProp::OpenProperty](imapiprop-openproperty.md) **IStream** ou **IStorage** .</span><span class="sxs-lookup"><span data-stu-id="dde94-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="dde94-121">Par exemple, les clients appeler **OpenProperty** avec **PR_ATTACH_DATA_BIN** , ainsi que la balise de propriété IID_IStream l’identificateur d’interface pour accéder à une pièce jointe binaire dans un message.</span><span class="sxs-lookup"><span data-stu-id="dde94-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="dde94-122">Clients et fournisseurs de services peuvent implémentent leurs propres flux et du stockage des objets ou appeler des fonctions API mises en œuvre d’accès fourni par MAPI ou COM.</span><span class="sxs-lookup"><span data-stu-id="dde94-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="dde94-123">Comme les implémentations fournies traiter la plupart des cas, les clients et les fournisseurs de services rarement doivent créer leurs propres.</span><span class="sxs-lookup"><span data-stu-id="dde94-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="dde94-124">Lorsqu’un client appelle **OpenProperty** sur un objet MAPI pour accéder à une de ses propriétés via un objet de stockage, le fournisseur de services s’ouvre généralement l’objet de stockage en mode direct.</span><span class="sxs-lookup"><span data-stu-id="dde94-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="dde94-125">Toutefois, il s’agit par défaut au lieu de comportement requis.</span><span class="sxs-lookup"><span data-stu-id="dde94-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="dde94-126">Les clients doivent partent du principe que tous les objets de stockage ouvert ou créé par les fournisseurs de services sont traitées et nécessitent un appel à **IStorage::Commit**.</span><span class="sxs-lookup"><span data-stu-id="dde94-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="dde94-127">Ils doivent également n’oubliez pas que les modifications apportées aux objets de stockage pas sera définitive jusqu'à ce qu’ils appellent **IMAPIProp::SaveChanges** après la dernière **Valider** pour enregistrer l’objet MAPI.</span><span class="sxs-lookup"><span data-stu-id="dde94-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="dde94-128">Pour plus d’informations, voir [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="dde94-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="dde94-129">MAPI et COM fournissent plusieurs fonctions de l’API pour définir ou accéder aux objets de stockage et de flux de données.</span><span class="sxs-lookup"><span data-stu-id="dde94-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="dde94-130">Les fonctions couramment utilisées sont décrits dans le tableau suivant.</span><span class="sxs-lookup"><span data-stu-id="dde94-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="dde94-131">**Fonctions permettant d’accéder aux objets Stream et stockage**</span><span class="sxs-lookup"><span data-stu-id="dde94-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="dde94-132">**Fonction**</span><span class="sxs-lookup"><span data-stu-id="dde94-132">**Function**</span></span>|<span data-ttu-id="dde94-133">**Description**</span><span class="sxs-lookup"><span data-stu-id="dde94-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="dde94-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="dde94-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="dde94-135">Crée un objet de stockage pour accéder à un objet d’octets de flux de données ou de verrou.</span><span class="sxs-lookup"><span data-stu-id="dde94-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="dde94-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="dde94-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="dde94-137">Crée un objet de message pour accéder à un objet de stockage.</span><span class="sxs-lookup"><span data-stu-id="dde94-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="dde94-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="dde94-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="dde94-139">Crée un objet stream pour accéder à un fichier.</span><span class="sxs-lookup"><span data-stu-id="dde94-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="dde94-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="dde94-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="dde94-141">Crée un objet stream qui contient la version compressée ou non compressée d’un objet stream contenant le texte enrichi d’un message.</span><span class="sxs-lookup"><span data-stu-id="dde94-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="dde94-142">**Pour récupérer les noms des flux de données dans un sous-stockage donné**</span><span class="sxs-lookup"><span data-stu-id="dde94-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="dde94-143">Appelez du sous-stockage **IStorage::EnumElements** pour obtenir une interface **IEnumSTATSTG** .</span><span class="sxs-lookup"><span data-stu-id="dde94-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="dde94-144">Appelez **IEnumSTATSTG::Next** avec structures **STATSTG** autant à la fois que vous le pouvez.</span><span class="sxs-lookup"><span data-stu-id="dde94-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="dde94-145">Si vous demandez 100 à la fois, **suivant** généralement renvoie S_FALSE avec le contenu de _pceltFetched_ défini sur le numéro qui ont été réellement récupérées.</span><span class="sxs-lookup"><span data-stu-id="dde94-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="dde94-146">Recherchez les structures **STATSTG** signalés avec STGTY_STREAM.</span><span class="sxs-lookup"><span data-stu-id="dde94-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="dde94-147">Le paramètre _pwcsName_ version.</span><span class="sxs-lookup"><span data-stu-id="dde94-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="dde94-148">**Pour créer un objet de stockage pour accéder à un objet octets flux ou de verrou existant**</span><span class="sxs-lookup"><span data-stu-id="dde94-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="dde94-149">Les clients appeler [HrIStorageFromStream](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="dde94-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="dde94-150">**Pour créer un objet de message pour accéder à un objet de stockage existant**</span><span class="sxs-lookup"><span data-stu-id="dde94-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="dde94-151">Clients et fournisseurs de services d’appel [OpenIMsgOnIStg](openimsgonistg.md).</span><span class="sxs-lookup"><span data-stu-id="dde94-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="dde94-152">Les objets de message généralement créés par les fournisseurs de banque de messages en ce sens qu’il ne prend pas en charge toutes les diffère de l’objet de message qui est créé le [IMessage : IMAPIProp](imessageimapiprop.md) méthodes, telles que **IMessage::SubmitMessage**de l’interface.</span><span class="sxs-lookup"><span data-stu-id="dde94-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="dde94-153">Un paramètre d’entrée facultatif à **OpenIMsgOnIStg** est une fonction de rappel qui est conforme au prototype [MSGCALLRELEASE](msgcallrelease.md) .</span><span class="sxs-lookup"><span data-stu-id="dde94-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="dde94-154">Cette fonction est appelée par le nouvel objet de message lorsque le décompte de références du message est égal à zéro.</span><span class="sxs-lookup"><span data-stu-id="dde94-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="dde94-155">Implémentation d’une fonction **MSGCALLRELEASE** peut être utile pour effectuer un traitement finale avant que le nouveau message est complètement supprimé.</span><span class="sxs-lookup"><span data-stu-id="dde94-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="dde94-156">[OpenStreamOnFile](openstreamonfile.md) est couramment utilisée pour stocker les pièces jointes, car elle crée un flux qui lit et écrit dans un fichier.</span><span class="sxs-lookup"><span data-stu-id="dde94-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="dde94-157">**OpenProperty** avec **PR_ATTACH_DATA_BIN** en tant que la balise de propriété crée un flux pour le stockage des données binaires de pièce jointe.</span><span class="sxs-lookup"><span data-stu-id="dde94-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="dde94-158">**Pour compresser ou décompresser un flux de données contenant le texte du message dans le Format de texte enrichi**</span><span class="sxs-lookup"><span data-stu-id="dde94-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="dde94-159">Les clients appeler [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="dde94-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="dde94-160">**WrapCompressedRTFStream** crée un flux qui encapsule le flux au format RTF.</span><span class="sxs-lookup"><span data-stu-id="dde94-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="dde94-161">Le flux de wrapper n’implémente pas toutes les méthodes **IStream** ; les méthodes suivantes sont exclues : **Seek**, **SetSize**, **Rétablir**, **LockRegion**, **UnlockRegion**, **jours fériés**et **Clone**.</span><span class="sxs-lookup"><span data-stu-id="dde94-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="dde94-162">C’est parce que les objets stream créés par **WrapCompressedRTFStream** ne prennent pas charge **SetSize** ou **Stat**, il n’est pas un moyen facile à étendre ou récupérer leur taille.</span><span class="sxs-lookup"><span data-stu-id="dde94-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="dde94-163">La meilleure stratégie consiste à choisir une taille de mémoire tampon raisonnable et lire ou écrire dans une boucle.</span><span class="sxs-lookup"><span data-stu-id="dde94-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="dde94-164">COM a une implémentation d’objet de stockage basée sur un tableau d’octets qui renvoie un objet **IEnumSTATSTG** à partir de la méthode **EnumElements** qui pose problème.</span><span class="sxs-lookup"><span data-stu-id="dde94-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="dde94-165">En particulier, la méthode **QueryInterface** ne fonctionne pas correctement.</span><span class="sxs-lookup"><span data-stu-id="dde94-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="dde94-166">Fournisseurs de services qui implémentent leurs propres objets de stockage à l’aide de l’implémentation COM doivent créer une fine pour l’objet **IEnumSTATSTG** qui transfère les appels sur les méthodes **IEnumSTATSTG** sous-jacentes, mais implémente ses propres **AddRef **, Méthodes **Clone** , **QueryInterface**et **release**.</span><span class="sxs-lookup"><span data-stu-id="dde94-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

