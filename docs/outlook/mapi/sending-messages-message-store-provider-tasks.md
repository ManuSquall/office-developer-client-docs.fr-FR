---
title: Envoi de Messages  T�ches de fournisseur de banque de messages
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: 'Derni�re modification�: lundi 9 mars 2015'
ms.openlocfilehash: 4af052cdbd354d321a1d9e1dd0feb004501c8eb0
ms.sourcegitcommit: 0cf39e5382b8c6f236c8a63c6036849ed3527ded
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/23/2018
ms.locfileid: "22587613"
---
# <a name="sending-messages-message-store-provider-tasks"></a><span data-ttu-id="68bf8-103">Envoi de Messages : T�ches de fournisseur de banque de messages</span><span class="sxs-lookup"><span data-stu-id="68bf8-103">Sending Messages: Message Store Provider Tasks</span></span>

<span data-ttu-id="68bf8-104">**S’applique à**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="68bf8-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="68bf8-p101">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span><span class="sxs-lookup"><span data-stu-id="68bf8-p101">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method. If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span></span> 
  
<span data-ttu-id="68bf8-p102">Le fournisseur de banque de messages d�termine s'il faut mettent en �uvre le spouleur MAPI. Si le fournisseur de banque de messages n'est pas fortement coupl�, le message n�cessite un pr�traitement, ou la banque �troitement coupl� et transport ne peuvent pas g�rer tous les destinataires, le spouleur MAPI doit �tre impliqu�.</span><span class="sxs-lookup"><span data-stu-id="68bf8-p102">The message store provider determines whether or not to involve the MAPI spooler. If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved.</span></span> 
  
<span data-ttu-id="68bf8-109">La proc�dure suivante d�crit les t�ches requises d'un fournisseur de banque de messages pour envoyer un message.</span><span class="sxs-lookup"><span data-stu-id="68bf8-109">The following procedure describes the tasks required of a message store provider for sending a message.</span></span> 
  
<span data-ttu-id="68bf8-110">**Dans IMessage::SubmitMessage, la banque de messages fournisseur**:</span><span class="sxs-lookup"><span data-stu-id="68bf8-110">**In IMessage::SubmitMessage, the message store provider**:</span></span>
  
1. <span data-ttu-id="68bf8-111">Appelle [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) si le message a l’indicateur MSGFLAG_RESEND dans sa propriété **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) et renvoie des erreurs au client.</span><span class="sxs-lookup"><span data-stu-id="68bf8-111">Calls [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) if the message has the MSGFLAG_RESEND flag set in its **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property and returns any errors to the client.</span></span> <span data-ttu-id="68bf8-112">**PrepareSubmit** vérifie la propriété **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) de chaque destinataire dans la liste des destinataires du message.</span><span class="sxs-lookup"><span data-stu-id="68bf8-112">**PrepareSubmit** checks the **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) property of each recipient in the message's recipient list.</span></span>
    
   - <span data-ttu-id="68bf8-113">Si l’indicateur MAPI_SUBMITTED est défini, indiquant que le destinataire n’a pas reçu le message d’origine, **PrepareSubmit** efface l’indicateur et définit la propriété **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) à TRUE.</span><span class="sxs-lookup"><span data-stu-id="68bf8-113">If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, **PrepareSubmit** clears the flag and sets the **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) property to TRUE.</span></span> 
    
   - <span data-ttu-id="68bf8-114">Si l'indicateur MAPI_SUBMITTED n'est pas d�fini, indiquant que le destinataire n'a re�u le message d'origine, **PrepareSubmit** modifie la propri�t� **PR_RECIPIENT_TYPE** MAPI_P1 et d�finit la propri�t� **PR_RESPONSIBILITY** sur TRUE et renvoie des erreurs g�n�r�es par **PrepareSubmit** au client.</span><span class="sxs-lookup"><span data-stu-id="68bf8-114">If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original messsage, **PrepareSubmit** changes the **PR_RECIPIENT_TYPE** property to MAPI_P1 and sets the **PR_RESPONSIBILITY** property to TRUE and returns any error generated by **PrepareSubmit** to the client.</span></span> 
    
2. <span data-ttu-id="68bf8-115">D�finit l'indicateur MSGFLAG_SUBMIT dans la propri�t� **PR_MESSAGE_FLAGS** du message.</span><span class="sxs-lookup"><span data-stu-id="68bf8-115">Sets the MSGFLAG_SUBMIT flag in the message's **PR_MESSAGE_FLAGS** property.</span></span> 
    
3. <span data-ttu-id="68bf8-116">Permet de s'assurer qu'il est une colonne pour **PR_RESPONSIBILITY** dans la table de destinataires et lui affecte la valeur FALSE pour indiquer qu'aucun transport n'a de responsabilit� encore suppos�e pour transmettre le message.</span><span class="sxs-lookup"><span data-stu-id="68bf8-116">Makes sure that there is a column for **PR_RESPONSIBILITY** in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</span></span> 
    
4. <span data-ttu-id="68bf8-117">Définit la date et l’heure d’origine dans la propriété **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="68bf8-117">Sets the date and time of origination in the **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) property.</span></span>
    
5. <span data-ttu-id="68bf8-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span><span class="sxs-lookup"><span data-stu-id="68bf8-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span></span> 
    
   - <span data-ttu-id="68bf8-119">D�veloppez toutes les listes de distribution personnelles et des destinataires personnalis�s et remplacez tous les noms d'affichage modifi� par leur nom d'origine.</span><span class="sxs-lookup"><span data-stu-id="68bf8-119">Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</span></span>
   - <span data-ttu-id="68bf8-120">Supprimer les doublons.</span><span class="sxs-lookup"><span data-stu-id="68bf8-120">Remove duplicate names.</span></span>
   - <span data-ttu-id="68bf8-121">Recherchez tout prétraitement nécessaires et si prétraitement est requise, définir l’indicateur NEEDS_PREPROCESSING et la propriété **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), une propriété réservée pour MAPI.</span><span class="sxs-lookup"><span data-stu-id="68bf8-121">Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) property, a property reserved for MAPI.</span></span> 
   - <span data-ttu-id="68bf8-122">D�finir l'indicateur NEEDS_SPOOLER si la banque de messages est fortement coupl�e � un type de transport et qu'il ne peut pas g�rer tous les destinataires.</span><span class="sxs-lookup"><span data-stu-id="68bf8-122">Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients.</span></span> 
    
6. <span data-ttu-id="68bf8-123">Ex�cute les t�ches suivantes si l'indicateur de message NEEDS_PREPROCESSING est d�fini :</span><span class="sxs-lookup"><span data-stu-id="68bf8-123">Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:</span></span>
    
   - <span data-ttu-id="68bf8-124">Place le message dans la file d’attente sortant avec le bit SUBMITFLAG_PREPROCESS défini dans la propriété **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="68bf8-124">Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) property.</span></span>
   - <span data-ttu-id="68bf8-125">Avertit le spouleur MAPI que la file d'attente a �t� modifi�e.</span><span class="sxs-lookup"><span data-stu-id="68bf8-125">Notifies the MAPI spooler that the queue has changed.</span></span>
   - <span data-ttu-id="68bf8-126">Rend le contr�le au client et le flux de messages continue dans le spouleur MAPI.</span><span class="sxs-lookup"><span data-stu-id="68bf8-126">Returns control to the client, and message flow continues in the MAPI spooler.</span></span> 
   - <span data-ttu-id="68bf8-127">Le spouleur MAPI effectue les t�ches suivantes :</span><span class="sxs-lookup"><span data-stu-id="68bf8-127">The MAPI spooler performs the following tasks:</span></span>
     - <span data-ttu-id="68bf8-128">Verrouille le message en appelant IMsgStore::SetLockState.</span><span class="sxs-lookup"><span data-stu-id="68bf8-128">Locks the message by calling IMsgStore::SetLockState.</span></span> 
     - <span data-ttu-id="68bf8-129">Effectue le prétraitement nécessaires en appelant toutes les fonctions de prétraitement dans l’ordre d’inscription.</span><span class="sxs-lookup"><span data-stu-id="68bf8-129">Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration.</span></span> <span data-ttu-id="68bf8-130">Fournisseurs de transport appellent IMAPISupport::RegisterPreprocessor à enregistrer les fonctions de prétraitement.</span><span class="sxs-lookup"><span data-stu-id="68bf8-130">Transport providers call IMAPISupport::RegisterPreprocessor to register preprocessing functions.</span></span> 
     - <span data-ttu-id="68bf8-131">Appelle IMessage::SubmitMessage sur le message ouvert pour indiquer à la banque de messages que le prétraitement est terminé.</span><span class="sxs-lookup"><span data-stu-id="68bf8-131">Calls IMessage::SubmitMessage on the open message to indicate to the message store that preprocessing is complete.</span></span>

<br/>

<span data-ttu-id="68bf8-132">Les deux étapes suivantes se produisent dans le processus client si il n’a pas de prétraitement et lorsque le spouleur MAPI appelle **SubmitMessage** si il a été prétraitement.</span><span class="sxs-lookup"><span data-stu-id="68bf8-132">The following two steps occur in the client process if there was no preprocessing, and when the MAPI spooler calls **SubmitMessage** if there was preprocessing.</span></span> 

<span data-ttu-id="68bf8-133">**La banque de messages fournisseur**:</span><span class="sxs-lookup"><span data-stu-id="68bf8-133">**The message store provider**:</span></span>

1. <span data-ttu-id="68bf8-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span><span class="sxs-lookup"><span data-stu-id="68bf8-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span></span>
    
   - <span data-ttu-id="68bf8-135">G�re tous les destinataires pouvoir prendre en charge.</span><span class="sxs-lookup"><span data-stu-id="68bf8-135">Handles any recipients that it can handle.</span></span>
   - <span data-ttu-id="68bf8-136">D�finit la propri�t� de **PR_RESPONSIBILITY** la valeur True pour tous les destinataires qu'il g�re.</span><span class="sxs-lookup"><span data-stu-id="68bf8-136">Sets the **PR_RESPONSIBILITY** property to TRUE for any recipients that it handles.</span></span> 
   - <span data-ttu-id="68bf8-137">Ex�cute les t�ches suivantes si tous les destinataires sont connus � ce magasin �troitement coupl� et de transport :</span><span class="sxs-lookup"><span data-stu-id="68bf8-137">Performs the following tasks if all recipients are known to this tightly coupled store and transport:</span></span>
     - <span data-ttu-id="68bf8-138">Appelle IMAPISupport::CompleteMsg si le message a été prétraité ou la banque de messages fournisseur souhaite le spouleur MAPI pour effectuer le traitement des messages, ce qui est recommandé afin que la messagerie crochets peuvent être appelées.</span><span class="sxs-lookup"><span data-stu-id="68bf8-138">Calls IMAPISupport::CompleteMsg if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked.</span></span> <span data-ttu-id="68bf8-139">Flux des messages se poursuit avec le spouleur MAPI comme décrit dans la procédure suivante.</span><span class="sxs-lookup"><span data-stu-id="68bf8-139">Message flow continues with the MAPI spooler as described in the following procedure.</span></span>  
     - <span data-ttu-id="68bf8-140">Exécute les tâches suivantes si le message a été prétraité pas ou le fournisseur de banque de messages ne souhaite pas le spouleur MAPI pour effectuer le traitement des messages :</span><span class="sxs-lookup"><span data-stu-id="68bf8-140">Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</span></span>
       - <span data-ttu-id="68bf8-141">Copie le message vers le dossier identifié par l’identificateur d’entrée dans la propriété PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId), s’il est défini.</span><span class="sxs-lookup"><span data-stu-id="68bf8-141">Copies the message to the folder identified by the entry identifier in the PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) property, if set.</span></span>
       - <span data-ttu-id="68bf8-142">Supprime le message si la propriété PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) a été définie sur TRUE.</span><span class="sxs-lookup"><span data-stu-id="68bf8-142">Deletes the message if the PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) property has been set to TRUE.</span></span>
       - <span data-ttu-id="68bf8-143">Déverrouille le message s’il est verrouillé.</span><span class="sxs-lookup"><span data-stu-id="68bf8-143">Unlocks the message if it is locked.</span></span>
       - <span data-ttu-id="68bf8-144">Renvoie au client.</span><span class="sxs-lookup"><span data-stu-id="68bf8-144">Returns to the client.</span></span> <span data-ttu-id="68bf8-145">Flux de messages est terminé.</span><span class="sxs-lookup"><span data-stu-id="68bf8-145">Message flow is complete.</span></span> 
   
2. <span data-ttu-id="68bf8-146">Ex�cute les t�ches suivantes si la banque de messages n'est pas �troitement coupl�e � un type de transport, pas tous les destinataires ont �t� connus pour la banque de messages ou l'indicateur NEEDS_SPOOLER est d�fini :</span><span class="sxs-lookup"><span data-stu-id="68bf8-146">Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:</span></span>
    
   - <span data-ttu-id="68bf8-147">Le message est plac� dans la file d'attente sortante sans d�finir le bit SUBMITFLAG_PREPROCESS dans la propri�t� **PR_SUBMIT_FLAGS**.</span><span class="sxs-lookup"><span data-stu-id="68bf8-147">Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the **PR_SUBMIT_FLAGS** property.</span></span> 
   - <span data-ttu-id="68bf8-148">Avertit le spouleur MAPI que la file d'attente sortante a chang� en g�n�rant une notification de la table.</span><span class="sxs-lookup"><span data-stu-id="68bf8-148">Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification.</span></span> 
   - <span data-ttu-id="68bf8-149">Renvoie au client et le flux des messages se poursuit avec un ensemble de t�ches effectu�es par le spouleur MAPI.</span><span class="sxs-lookup"><span data-stu-id="68bf8-149">Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</span></span>
    
<span data-ttu-id="68bf8-p107">Lorsqu'un message doit �tre g�r�e par le spouleur MAPI, le fournisseur de banque de messages d�finit la propri�t� du message **PR_SUBMIT_FLAGS** � SUBMITFLAG_LOCKED. L'indicateur SUBMITFLAG_LOCKED indique que le spouleur MAPI a verrouill� le message pour son usage exclusif. L'autre valeur pour **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, est d�finie lorsque le message n�cessite un pr�traitement par une ou plusieurs fonctions pr�processeur enregistr�es par un fournisseur de transport.</span><span class="sxs-lookup"><span data-stu-id="68bf8-p107">When a message is to be handled by the MAPI spooler, the message store provider sets the message's **PR_SUBMIT_FLAGS** property to SUBMITFLAG_LOCKED. The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use. The other value for **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</span></span> 
  

