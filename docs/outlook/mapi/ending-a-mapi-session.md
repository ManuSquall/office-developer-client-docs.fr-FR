---
title: Fermeture d'une session MAPI
manager: soliver
ms.date: 11/16/2014
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: ca153737-75dc-426a-a410-7a7ab3264f23
description: 'Dernière modification : 23 juillet 2011'
ms.openlocfilehash: 74c2a7247df02570761247a9e4a6fae378f37312
ms.sourcegitcommit: 8fe462c32b91c87911942c188f3445e85a54137c
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 04/23/2019
ms.locfileid: "32287152"
---
# <a name="ending-a-mapi-session"></a><span data-ttu-id="19e7a-103">Fermeture d'une session MAPI</span><span class="sxs-lookup"><span data-stu-id="19e7a-103">Ending a MAPI Session</span></span>

  
  
<span data-ttu-id="19e7a-104">**S’applique à** : Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="19e7a-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="19e7a-105">Les clients peuvent terminer leurs sessions en réponse à la demande d'un utilisateur, immédiatement ou après que tous les messages sortants ont été traités, et lorsqu'une erreur critique se produit.</span><span class="sxs-lookup"><span data-stu-id="19e7a-105">Clients can end their sessions in response to a user's request, either immediately or after all outbound messages have been processed, and when a critical error occurs.</span></span> <span data-ttu-id="19e7a-106">Certains clients doivent rester connectés afin que les messages sortants en attente puissent atteindre le fournisseur de transport et le système de messagerie de destination.</span><span class="sxs-lookup"><span data-stu-id="19e7a-106">Some clients need to stay logged on so that pending outbound messages can reach the transport provider and the destination messaging system.</span></span> <span data-ttu-id="19e7a-107">Si un client de ce type envoie un message et se déconnecte immédiatement, le message peut rester dans la file d'attente sortante jusqu'à ce qu'un utilisateur se reconnecte et reste connecté suffisamment longtemps pour que le message soit transmis.</span><span class="sxs-lookup"><span data-stu-id="19e7a-107">If such a client sends a message and immediately logs off, the message may remain in the outgoing queue until a user logs back on and stays logged on long enough for the message to be transmitted.</span></span>
  
 <span data-ttu-id="19e7a-108">**Lorsque vous devez terminer votre session avec le sous-système MAPI**</span><span class="sxs-lookup"><span data-stu-id="19e7a-108">**When you need to terminate your session with the MAPI subsystem**</span></span>
  
1. <span data-ttu-id="19e7a-109">Annuler les inscriptions pour toutes les notifications en appelant \*\*\*\* la méthode Unadvise de chaque objet inscrit.</span><span class="sxs-lookup"><span data-stu-id="19e7a-109">Cancel the registrations for all notifications by calling the **Unadvise** method of every registered object.</span></span> 
    
2. <span data-ttu-id="19e7a-110">Libérez tous les objets ouverts en appelant leurs méthodes [IUnknown:: Release](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) .</span><span class="sxs-lookup"><span data-stu-id="19e7a-110">Release all open objects by calling their [IUnknown::Release](https://msdn.microsoft.com/library/ms682317%28VS.85%29.aspx) methods.</span></span> <span data-ttu-id="19e7a-111">Les types d'objets ouverts peuvent inclure des récepteurs de notification, la table d'État, le dossier boîte d'envoi, un ou plusieurs magasins de messages et le carnet d'adresses.</span><span class="sxs-lookup"><span data-stu-id="19e7a-111">The types of open objects can include advise sinks, the status table, the Outbox folder, one or more message stores, and the address book.</span></span> 
    
3. <span data-ttu-id="19e7a-112">Appelez [MAPIFreeBuffer](mapifreebuffer.md) pour libérer de la mémoire pour les identificateurs d'entrée mis en cache, tels que **PR_IPM_SUBTREE_ENTRYID** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="19e7a-112">Call [MAPIFreeBuffer](mapifreebuffer.md) to free the memory for any cached entry identifiers, such as **PR_IPM_SUBTREE_ENTRYID** ([PidTagIpmSubtreeEntryId](pidtagipmsubtreeentryid-canonical-property.md)).</span></span>
    
4. <span data-ttu-id="19e7a-113">Appelez [IMAPISession:: Logoff](imapisession-logoff.md), en définissant l'indicateur MAPI_LOGOFF_UI si vous autorisez une interface utilisateur et l'indicateur MAPI_LOGOFF_SHARED si vous êtes propriétaire de la session partagée active.</span><span class="sxs-lookup"><span data-stu-id="19e7a-113">Call [IMAPISession::Logoff](imapisession-logoff.md), setting the MAPI_LOGOFF_UI flag if you allow a user interface and the MAPI_LOGOFF_SHARED flag if you own the current shared session.</span></span> <span data-ttu-id="19e7a-114">\*\*\*\* La déconnexion indique à tous les clients qui utilisent la session partagée active de se déconnecter en envoyant une notification d'erreur.</span><span class="sxs-lookup"><span data-stu-id="19e7a-114">**Logoff** notifies all other clients that are using the current shared session that they should log off by sending an error notification.</span></span> 
    
5. <span data-ttu-id="19e7a-115">Libérez le pointeur de session en appelant la méthode **IUnknown:: Release** de la session.</span><span class="sxs-lookup"><span data-stu-id="19e7a-115">Release the session pointer by calling the session's **IUnknown::Release** method.</span></span> 
    
6. <span data-ttu-id="19e7a-116">Si vous avez appelé [OleInitialize](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) pendant le démarrage de la session pour initialiser les bibliothèques OLE, ne l'initialisez pas maintenant en appelant [OleUninitialize](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="19e7a-116">If you called [OleInitialize](https://msdn.microsoft.com/library/ms690134%28v=VS.85%29.aspx) during session startup to initialize the OLE libraries, uninitialize them now by calling [OleUninitialize](https://msdn.microsoft.com/library/ms691326%28VS.85%29.aspx).</span></span> <span data-ttu-id="19e7a-117">Seuls les clients qui ont appelé **OleInitialize** doivent appeler **OleUninitialize**.</span><span class="sxs-lookup"><span data-stu-id="19e7a-117">Only clients that have called **OleInitialize** must call **OleUninitialize**.</span></span> 
    
7. <span data-ttu-id="19e7a-118">Désinitialisez les bibliothèques MAPI en appelant [MAPIUninitialize](mapiuninitialize.md).</span><span class="sxs-lookup"><span data-stu-id="19e7a-118">Uninitialize the MAPI libraries by calling [MAPIUninitialize](mapiuninitialize.md).</span></span> <span data-ttu-id="19e7a-119">Si vous avez appelé **OleInitialize** à un moment donné, assurez-vous qu'un appel à **OleUninitialize** se produit avant cet appel vers **MAPIUninitialize**.</span><span class="sxs-lookup"><span data-stu-id="19e7a-119">If you called **OleInitialize** at some point, make sure that a call to **OleUninitialize** occurs before this call to **MAPIUninitialize**.</span></span> <span data-ttu-id="19e7a-120">La synchronisation est essentielle.</span><span class="sxs-lookup"><span data-stu-id="19e7a-120">The timing is crucial.</span></span> <span data-ttu-id="19e7a-121">Si l'appel à **OleUninitialize** suit l'appel à **MAPIUninitialize**, votre client peut se terminer de manière inappropriée.</span><span class="sxs-lookup"><span data-stu-id="19e7a-121">If the call to **OleUninitialize** follows the call to **MAPIUninitialize**, your client might terminate ungracefully.</span></span> 
    
8. <span data-ttu-id="19e7a-122">Si vous avez appelé [ScInitMapiUtil](scinitmapiutil.md) pendant le démarrage de session pour initialiser la bibliothèque d'utilitaires MAPI, ne l'initialisez pas maintenant en appelant [DeinitMapiUtil](deinitmapiutil.md).</span><span class="sxs-lookup"><span data-stu-id="19e7a-122">If you called [ScInitMapiUtil](scinitmapiutil.md) during session startup to initialize the MAPI utility library, uninitialize it now by calling [DeinitMapiUtil](deinitmapiutil.md).</span></span> <span data-ttu-id="19e7a-123">Seuls les clients qui ont appelé **ScInitMapiUtil** doivent appeler **DeinitMapiUtil**.</span><span class="sxs-lookup"><span data-stu-id="19e7a-123">Only clients that have called **ScInitMapiUtil** must call **DeinitMapiUtil**.</span></span>
    
> [!NOTE]
> <span data-ttu-id="19e7a-124">Tous les objets ouverts doivent être libérés avant l'appel à **IMAPISession:: Logoff**.</span><span class="sxs-lookup"><span data-stu-id="19e7a-124">All open objects must be released before the call to **IMAPISession::Logoff**.</span></span> <span data-ttu-id="19e7a-125">Les objets qui restent ouverts après la **fermeture de session** sont appelés deviennent non valides; ils ne peuvent pas accepter d'appels et ne peuvent jamais être libérés.</span><span class="sxs-lookup"><span data-stu-id="19e7a-125">Objects that remain open after **Logoff** is called become invalid; they cannot accept any calls and might never be freed.</span></span> <span data-ttu-id="19e7a-126">Si un de ces objets est appelé, attendez-vous à ce que l'appel échoue.</span><span class="sxs-lookup"><span data-stu-id="19e7a-126">If a call is made to one of these objects, expect the call to fail.</span></span> 
  
 <span data-ttu-id="19e7a-127">MAPI n'a pas de mécanisme de suppression des dll pendant le processus d'arrêt de session.</span><span class="sxs-lookup"><span data-stu-id="19e7a-127">MAPI has no mechanism for deleting DLLs during the session shutdown process.</span></span> <span data-ttu-id="19e7a-128">La DLL d'un fournisseur de services ne peut être supprimée que si un client de configuration tel que le panneau de configuration appelle sa fonction de point d'entrée de service de messagerie avec l'événement MSG_SERVICE_INSTALL.</span><span class="sxs-lookup"><span data-stu-id="19e7a-128">A service provider's DLL can only be deleted when a configuration client such as the Control Panel calls its message service entry point function with the MSG_SERVICE_INSTALL event.</span></span> 
  

